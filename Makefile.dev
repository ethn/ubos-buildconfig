#
# Makefile for the dev channel
#

VERBOSE=-v
# VERBOSE=-v -v -i
CHANNEL=dev

include common.mk

## Public targets

TARGETS=\
	build-and-upload-packages \
	build-images \
	build-packages \
	burn-to-usb \
	code-is-current \
	pacsane \
	run-webapptests \
	run-webapptests-hl \
	run-webapptests-workout

build-packages :
	GNUPGHOME=$(GNUPGHOME) macrobuild UBOS::Macrobuild::BuildTasks::BuildDev \
		--configdir "$(CONFIGDIR)" \
		--archUpstreamSite "$(ARCHUPSTREAMSITE)" \
		--arch "$(ARCH)" \
		--builddir "$(BUILDDIR)" \
		--repodir "$(REPODIR)" \
		--channel "$(CHANNEL)" \
		$(SIGNPACKAGESARG) \
		$(SIGNDBSARG) \
		$(VERBOSE)

build-and-upload-packages :
	[ ! -z "$(ARCHUPSTREAMSITE)" ]
	GNUPGHOME=$(GNUPGHOME) macrobuild UBOS::Macrobuild::BuildTasks::BuildAndUploadDev \
		--configdir "$(CONFIGDIR)" \
		--archUpstreamSite "$(ARCHUPSTREAMSITE)" \
		--arch "$(ARCH)" \
		--builddir "$(BUILDDIR)" \
		--repodir "$(REPODIR)" \
		--channel "$(CHANNEL)" \
		--uploadDest "$(UPLOADDEST)" \
		--uploadSshKey "$(UPLOADSSHKEY)" \
		$(SIGNPACKAGESARG) \
		$(SIGNDBSARG) \
		$(VERBOSE)

# Check out code from git. Rebuild, and re-install, but only if there have been updates
# This is not a dependency so the user can decide whether they want to update the code
code-is-current :
	[ -d "$(WORKAREA)/git/github.com/indiebox" ] || mkdir -p "$(WORKAREA)/git/github.com/indiebox"
	( cd "$(WORKAREA)/git/github.com/indiebox"; \
		for p in ubos-admin macrobuild macrobuild-ubos perl tools; do \
			if [ -d "$$p" ]; then \
				( cd "$$p"; git pull | grep 'Already up-to-date' > /dev/null || rm -f *pkg* */*pkg* ); \
			else \
				git clone "https://github.com/indiebox/$$p"; \
			fi; \
		done )
	( cd "$(WORKAREA)/git/github.com/indiebox"; \
		for p in ubos-admin/ubos-perl-utils perl/perl-log-journald macrobuild macrobuild-ubos tools/webapptest tools/pacsane; do \
			( cd "$$p"; ls -d *pkg* > /dev/null 2>&1 || ( env -i makepkg -c -f && sudo pacman -U --noconfirm *pkg* )) \
		done )

